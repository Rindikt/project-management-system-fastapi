# .github/workflows/ci.yml

name: Continuous Integration and Deployment (CI/CD)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Ручной запуск

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Создаем .env-db для сервиса 'db'
      - name: Create DB .env file
        run: |
          echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env-db
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env-db
          echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env-db

      # 2. Создаем .env для сервисов 'backend' и 'tests'
      - name: Create Backend .env file
        run: |
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "DATABASE_URL=postgresql+asyncpg://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@db:5432/${{ secrets.POSTGRES_DB }}" >> .env

      # 3. Запускаем Docker Compose для сборки и запуска тестов
      - name: Start services and Build Images
        run: docker compose up -d --build db backend tests

      # 4. Запуск тестов в контейнере
      - name: Run Tests
        run: docker compose run --rm tests
  
  build_push: # НОВЫЙ JOB: Сборка и публикация образов
    needs: test # Запускается только после успешного прохождения тестов
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # 1. Вход в Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      # 2. Настройка Buildx (для кэширования и лучшей сборки)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Сборка и публикация образа Backend
      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: . 
          file: ./Dockerfile # Ваш основной Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/project-backend:latest 
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 4. Сборка и публикация образа Frontend
      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend # Контекст - папка frontend
          file: ./frontend/Dockerfile # Файл Dockerfile в папке frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/project-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  simulate_deploy:
    needs: build_push
    runs-on: ubuntu-latest

    steps:
      - name: Show Deployment Readiness (Simulated)
        run: |
          echo "================================================================"
          echo "SUCCESS: CD Pipeline is fully prepared for remote deployment."
          echo "================================================================"
          echo "The following commands would be executed via SSH on the Production Server:"
          
          # 1. Выполнить вход в Docker Hub (чтобы сервер мог скачать ваши образы)
          echo 'echo "${{ secrets.DOCKER_PASSWORD }}" | docker login --username ${{ secrets.DOCKER_USERNAME }} --password-stdin'
          
          # 2. Скачать новые образы из Docker Hub
          echo 'docker compose pull backend frontend'
          
          # 3. Запустить их, принудительно пересоздав контейнеры
          echo 'docker compose up -d --force-recreate backend frontend'
          
          echo "----------------------------------------------------------------"
          echo "This Job simulates the final deployment stage for portfolio demonstration."